version: '3.8'

services:
  # GGM 服务 - Gemini API 代理
  ggm:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ggm
    restart: unless-stopped
    ports:
      - "${GGM_PORT:-8000}:8000"
    volumes:
      # 持久化数据
      - ./backend/GGM/data:/app/GGM/data
      # 配置文件（可选，也可以直接修改镜像内的 config.py）
      - ./backend/config.py:/app/config.py:ro
      - ./backend/GGM:/app/GGM
    environment:
      - TZ=Asia/Shanghai
      # 使用 host.docker.internal 自动解析宿主机网关 IP
      - GEMINI_PROXY=socks5h://host.docker.internal:1080
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: python -u GGM/run.py --no-clear
    networks:
      - webdev-network
    # 2G 服务器内存限制（需要运行 Playwright 浏览器，增加内存）
    deploy:
      resources:
        limits:
          memory: 1024M
        reservations:
          memory: 256M
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request, sys; r=urllib.request.urlopen('http://localhost:8000/health', timeout=5); sys.exit(0 if r.status == 200 else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Auth 认证服务
  auth:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: auth
    restart: unless-stopped
    ports:
      - "${AUTH_PORT:-8001}:8001"
    volumes:
      # 持久化数据库
      - auth_data:/app/auth/data
      # 配置文件
      - ./backend/config.py:/app/config.py:ro
    environment:
      - TZ=Asia/Shanghai
    command: python -u auth/run.py
    networks:
      - webdev-network
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request, sys; r=urllib.request.urlopen('http://localhost:8001/health', timeout=5); sys.exit(0 if r.status == 200 else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 监控服务
  monitor:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: monitor
    restart: unless-stopped
    ports:
      - "${MONITOR_PORT:-3001}:3001"
    volumes:
      # 持久化数据
      - monitor_data:/app/monitoringDashboard/data
      # 配置文件
      - ./backend/config.py:/app/config.py:ro
    environment:
      - TZ=Asia/Shanghai
    command: python -u monitoringDashboard/run.py
    networks:
      - webdev-network
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

  # 前端 Nginx 服务
  frontend:
    image: nginx:alpine
    container_name: frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-80}:80"
    volumes:
      - ./frontend:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      # HTTPS 证书挂载（先申请证书，再重启 frontend）
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/www/certbot:/var/www/certbot:ro
    depends_on:
      - ggm
      - auth
      - monitor
    networks:
      - webdev-network
    deploy:
      resources:
        limits:
          memory: 64M
        reservations:
          memory: 16M

networks:
  webdev-network:
    driver: bridge

volumes:
  auth_data:
  monitor_data:
